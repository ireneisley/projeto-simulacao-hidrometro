package hidrometro;

import javax.swing.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;
import java.util.List;
import java.util.ArrayList;

/**
 * Classe principal que orquestra a simula칞칚o de m칰ltiplos hidr칪metros
 */
public class Controladora {
    private Configuracao configuracao;
    private List<Hidrometro> hidrometros;
    private boolean simulacaoAtiva;

    private ScheduledExecutorService scheduler;
    private ScheduledExecutorService schedulerEventos;
    private ScheduledExecutorService schedulerImagens;

    private List<JFrame> frames;

    public Controladora() {
        this.configuracao = new Configuracao();
        this.hidrometros = new ArrayList<>();
        this.frames = new ArrayList<>();
        this.simulacaoAtiva = false;
        this.scheduler = Executors.newScheduledThreadPool(10);
        this.schedulerEventos = Executors.newScheduledThreadPool(5);
        this.schedulerImagens = Executors.newScheduledThreadPool(5);
    }

    public void carregarConfiguracao(String arquivo) {
        try {
            configuracao.carregarDeArquivo(arquivo);
            if (!configuracao.validarConfiguracao()) {
                throw new IllegalArgumentException("Configura칞칚o inv치lida");
            }
            System.out.println("Configura칞칚o carregada com sucesso de: " + arquivo);

            if (configuracao.isModoDebug()) {
                System.out.println("Modo debug ativado");
                System.out.println("Configura칞칚o: " + configuracao.getConfig());
            }

        } catch (Exception e) {
            System.out.println("Erro ao carregar configura칞칚o, usando valores padr칚o");
            System.out.println("Erro: " + e.getMessage());
        }
    }

    public void iniciarSimulacao() {
        if (simulacaoAtiva) {
            System.out.println("Simula칞칚o j치 est치 ativa");
            return;
        }

        // Limpar hidr칪metros e frames anteriores
        hidrometros.clear();
        frames.clear();

        // Criar hidr칪metros baseados na configura칞칚o
        List<ConfiguracaoDTO> configs = configuracao.getConfiguracoes();

        for (int i = 0; i < configs.size(); i++) {
            ConfiguracaoDTO config = configs.get(i);
            Hidrometro h = new Hidrometro(config);
            h.iniciar();
            hidrometros.add(h);

            // Criar uma janela individual para cada hidr칪metro
            JFrame frame = new JFrame("Simulador " + config.id() + " - " +
                    LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss")));

            // Configurar janela
            frame.setDefaultCloseOperation(JFrame.HIDE_ON_CLOSE); // N칚o fechar toda aplica칞칚o
            frame.add(h.getDisplay());
            frame.pack();

            // Posicionar janelas em cascade (uma ao lado da outra)
            int offset = i * 50;
            frame.setLocation(100 + offset, 100 + offset);
            frame.setVisible(true);

            frames.add(frame);
        }

        simulacaoAtiva = true;

        System.out.println("Simula칞칚o iniciada com " + hidrometros.size() + " hidr칪metros em janelas separadas");

        iniciarThreadsSimulacao();
    }

    private void iniciarThreadsSimulacao() {
        // Thread de medi칞칚o para cada hidr칪metro
        for (int i = 0; i < hidrometros.size(); i++) {
            final int index = i;
            scheduler.scheduleAtFixedRate(() -> {
                if (simulacaoAtiva && index < hidrometros.size()) {
                    try {
                        Hidrometro h = hidrometros.get(index);
                        System.out.println("Atualizando medi칞칫es do " + h.getConfig().id() + " a cada 1s");
                        double medicao = h.medir();
                        double pressao = h.calcularPressao();

                        if (h.getConfig().modoDebug()) {
                            System.out.printf("[DEBUG %s] Medi칞칚o: %.2f L/min | Press칚o: %.2f bar%n",
                                    h.getConfig().id(), medicao, pressao);
                        }

                    } catch (Exception e) {
                        System.err.println("Erro na medi칞칚o do hidr칪metro " + index + ": " + e.getMessage());
                    }
                }
            }, 0, 1, TimeUnit.SECONDS);
        }

        // Thread de atualiza칞칚o do display para cada hidr칪metro
        for (int i = 0; i < hidrometros.size(); i++) {
            final int index = i;
            scheduler.scheduleAtFixedRate(() -> {
                if (simulacaoAtiva && index < hidrometros.size()) {
                    Hidrometro h = hidrometros.get(index);
                    System.out.println("Mostrando Display do " + h.getConfig().id() + "!");
                    SwingUtilities.invokeLater(() -> {
                        h.getDisplay().atualizarDados();

                    });
                }
            }, 0, configuracao.getTempoAtualizacao() / 1000, TimeUnit.SECONDS);
        }

        // Thread de eventos para cada hidr칪metro
        for (int i = 0; i < hidrometros.size(); i++) {
            final int index = i;
            schedulerEventos.scheduleAtFixedRate(() -> {
                if (simulacaoAtiva && index < hidrometros.size()) {
                    Hidrometro h = hidrometros.get(index);
                    // Simular falta de 치gua baseado na configura칞칚o espec칤fica
                    if (Math.random() * 100 < h.getConfig().chanceFaltaAgua()) {
                        System.out.println("丘멆잺 Simulando falta de 치gua no " + h.getConfig().id() + "...");
                        h.simularFaltaAgua();
                    }
                }
            }, 2, 5, TimeUnit.SECONDS);
        }

        // Thread de gera칞칚o de imagens para cada hidr칪metro
        for (int i = 0; i < hidrometros.size(); i++) {
            final int index = i;
            schedulerImagens.scheduleAtFixedRate(() -> {
                if (simulacaoAtiva && index < hidrometros.size()) {
                    try {
                        Hidrometro h = hidrometros.get(index);
                        System.out.println("游닞 Gerando imagem do " + h.getConfig().id() + "...");
                        h.gerarImagemAtualizada();
                    } catch (Exception e) {
                        System.err.println("Erro ao gerar imagem do hidr칪metro " + index + ": " + e.getMessage());
                    }
                }
            }, 3, 3, TimeUnit.SECONDS);
        }
    }

    public void pararSimulacao() {
        if (!simulacaoAtiva) {
            System.out.println("Simula칞칚o n칚o est치 ativa");
            return;
        }

        simulacaoAtiva = false;

        if (scheduler != null && !scheduler.isShutdown()) {
            scheduler.shutdown();
        }
        if (schedulerEventos != null && !schedulerEventos.isShutdown()) {
            schedulerEventos.shutdown();
        }
        if (schedulerImagens != null && !schedulerImagens.isShutdown()) {
            schedulerImagens.shutdown();
        }

        // Parar todos os hidr칪metros
        for (Hidrometro h : hidrometros) {
            h.parar();
        }

        // Atualizar t칤tulos de todas as janelas
        for (int i = 0; i < frames.size() && i < hidrometros.size(); i++) {
            final int index = i;
            SwingUtilities.invokeLater(() -> {
                JFrame frameHidrometro = frames.get(index);
                Hidrometro h = hidrometros.get(index);
                frameHidrometro.setTitle("Simulador " + h.getConfig().id() + " - " +
                        LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss")) +
                        " - Simula칞칚o Encerrada");
            });
        }

        System.out.println("Simula칞칚o parada para " + hidrometros.size() + " hidr칪metros");
    }

    public void executar() {
        try {
            iniciarSimulacao();

            int tempoSimulacao = configuracao.getTempoSimulacao();

            if (tempoSimulacao > 0) {
                System.out.println("Executando simula칞칚o por " + tempoSimulacao + " segundos...");

                scheduler.schedule(() -> {
                    System.out.println("Encerrando simula칞칚o...");
                    pararSimulacao();

                    if (!scheduler.isTerminated()) {
                        // Atualizar t칤tulos de todas as janelas para indicar fim da simula칞칚o
                        for (int i = 0; i < frames.size() && i < hidrometros.size(); i++) {
                            final int index = i;
                            SwingUtilities.invokeLater(() -> {
                                JFrame frameHidrometro = frames.get(index);
                                Hidrometro h = hidrometros.get(index);
                                frameHidrometro.setTitle("Simulador " + h.getConfig().id() + " - " +
                                        LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss")) +
                                        " - Simula칞칚o Encerrada");
                            });
                        }
                    }
                }, tempoSimulacao, TimeUnit.SECONDS);

                // Manter thread principal viva
                while (simulacaoAtiva) {
                    Thread.sleep(1000);
                }
            } else {
                System.out.println("Simula칞칚o em execu칞칚o cont칤nua. Feche a janela para parar.");
                // Manter vivo indefinidamente
                while (simulacaoAtiva) {
                    Thread.sleep(1000);
                }
            }

        } catch (InterruptedException e) {
            System.out.println("Simula칞칚o interrompida");
            pararSimulacao();
        } catch (IllegalArgumentException ignored) {
            // Ignorar exce칞칫es de argumentos inv치lidos como no simulador de refer칡ncia
        }

        System.out.println("Simula칞칚o conclu칤da");
    }

    public boolean isSimulacaoAtiva() {
        return simulacaoAtiva;
    }

    public List<Hidrometro> getHidrometros() {
        return new ArrayList<>(hidrometros);
    }

    public Hidrometro getHidrometro(int indice) {
        if (indice < 0 || indice >= hidrometros.size()) {
            throw new IndexOutOfBoundsException("칈ndice inv치lido: " + indice);
        }
        return hidrometros.get(indice);
    }
}
